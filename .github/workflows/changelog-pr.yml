name: Create Changelog Pull Request

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    env:
      CONFIG_PATH: .github/changelog-pr-config.json
      BRANCH_NAME: github-action-update-changelog
      AUTOMATED_PR_LABEL: "automated pr"
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest date in changelog
        run: |
          LATEST_DATE=$(grep '^## [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}' CHANGELOG.md | head -n 1 | awk '{print $2}')
          TODAY=$(date -u +%Y-%m-%d)
          echo "LATEST_DATE=$LATEST_DATE" >> $GITHUB_ENV
          echo "TODAY=$TODAY" >> $GITHUB_ENV

      - name: Get merged PRs since last changelog
        id: merged_prs
        uses: actions/github-script@v7
        with:
          script: |
            const latestDate = new Date(process.env.LATEST_DATE).toISOString();
            const pulls = (await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: "main",
              state: "closed",
              sort: "updated",
              direction: "desc",
              per_page: 100
            })).data;

            const mergedPRs = pulls.filter(pr => pr.merged_at && new Date(pr.merged_at) > new Date(latestDate));
            return mergedPRs.map(pr => `- ${pr.title} [@${pr.user.login}](https://github.com/${pr.user.login}) ([#${pr.number}](${pr.html_url}))`).join("\n");

      - name: Update CHANGELOG.md
        if: steps.merged_prs.outputs.result != ''
        run: |
          echo -e "## $TODAY\n\n### Changes\n\n$(cat <<< "${{ steps.merged_prs.outputs.result }}")\n\n$(cat CHANGELOG.md)" > CHANGELOG.md

      - name: Commit and push changes
        if: steps.merged_prs.outputs.result != ''
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "Update CHANGELOG.md"
          git push origin $BRANCH_NAME --force
